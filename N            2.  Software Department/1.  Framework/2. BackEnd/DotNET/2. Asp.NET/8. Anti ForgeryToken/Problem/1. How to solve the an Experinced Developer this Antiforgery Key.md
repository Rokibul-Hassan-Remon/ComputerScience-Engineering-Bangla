**From a Simple File Upload to a Web Security Deep Dive: CSRF in ASP.NET Core**

ржПржХржЯрж┐ рж╕рж╛ржзрж╛рж░ржг ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб ржПржирзНржбржкрзЯрзЗржирзНржЯ ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯ ржХрж░рж╛рж░ ржХрж╛ржЬ ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрж┐рж▓ тАФ ржХрж┐ржирзНрждрзБ рждрж╛ ржзрзАрж░рзЗ ржзрзАрж░рзЗ рж░рзВржк ржирзЗрзЯ ASP.NET Core-ржП anti-forgery ржорзЗржХрж╛ржирж┐ржЬржо ржирж┐рзЯрзЗ ржПржХржЯрж┐ ржЧржнрзАрж░ ржЕржирзБрж╕ржирзНржзрж╛ржирзЗред

ржЖржорж┐ Minimal APIs ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐рж▓рж╛ржо, ржЖрж░ рж╣ржарж╛рзО ржХрж░рзЗржЗ antiforgery token рж╕ржВржХрзНрж░рж╛ржирзНржд рж╕ржорж╕рзНржпрж╛рзЯ ржкрзЬрж▓рж╛ржоред ржкрзНрж░ржержорзЗ ржХрж┐ржЫрзБржЗ ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐рж▓рж╛ржо ржирж╛ред ржЖржорж┐ рждрзЛ [ValidateAntiForgeryToken] ржЕрзНржпрж╛ржЯрзНрж░рж┐ржмрж┐ржЙржЯ ржХрзЛржерж╛ржУ ржжрж┐ржЗржирж┐ред ржХрж┐ржирзНрждрзБ ржкрж░рзЗ ржЬрж╛ржирждрзЗ ржкрж╛рж░рж┐, Minimal APIs рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ anti-forgery protection ржкрзНрж░рзЯрзЛржЧ ржХрж░рзЗ multipart/form-data рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗ, ржпржжрж┐ ржирж╛ ржЖржкржирж┐ рж╕рзЗржЯрж╛ рж╕рзНржкрж╖рзНржЯржнрж╛ржмрзЗ ржирж┐рж╖рзНржХрзНрж░рж┐рзЯ ржХрж░рзЗржиред

рждрж╛ржЗ ржЖржорж┐ ржПржХржЯрж┐ ржПржирзНржбржкрзЯрзЗржирзНржЯ ржпрзЛржЧ ржХрж░рж▓рж╛ржо ржпрж╛рждрзЗ antiforgery token ржлрзЗржЪ ржХрж░рж╛ ржпрж╛рзЯ ржПржмржВ ржлрзНрж░ржирзНржЯржПржирзНржб (Next.js + Axios) ржХрзЗ рж╕рзЗржЯрж┐ ржкрж╛ржарж╛ржирзЛрж░ ржЬржирзНржп ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж▓рж╛ржоред рждржмрзБржУ, рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржмрзНржпрж░рзНрже рж╣ржЪрзНржЫрж┐рж▓ред

рждржЦржи ржЖржорж┐ ржмрзБржЭрж▓рж╛ржо: рж╢рзБржзрзБ token ржпржерзЗрж╖рзНржЯ ржирзЯ тАФ ASP.NET Core ржЪрж╛рзЯ ржПржХржЯрж┐ anti-forgery cookie-ржУ ржпрзЗржи рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗрж░ рж╕рж╛ржерзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯред ржХрж┐ржирзНрждрзБ ржмрзНрж░рж╛ржЙржЬрж╛рж░ рж╕рзЗржЯрж╛ ржкрж╛ржарж╛ржЪрзНржЫрж┐рж▓ ржирж╛ред

Network tab ржЪрзЗржХ ржХрж░рзЗ ржжрзЗржЦрж┐ ржЖржорж┐ withCredentials: true ржпрзБржХрзНржд ржХрж░рж┐ржирж┐ ржЖржорж╛рж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗред ржПржЯрж╛ рж╕рж╣ржЬ рж╕ржорж╛ржзрж╛ржи тАФ ржЖржорж┐ рж╕рзЗржЯрж╛ ржЕрзНржпрж╛ржб ржХрж░рж▓рж╛ржоред ржХрж┐ржирзНрждрзБ рж╕ржорж╕рзНржпрж╛ рждржмрзБржУ рж░рзЯрзЗ ржЧрзЗрж▓ред

ржЖрж░ржУ ржЧржнрзАрж░рзЗ ржЧрж┐рзЯрзЗ ржжрзЗржЦрж┐ Aspire ржжрзНржмрж╛рж░рж╛ cookie ржирж╛ржоржЯрж┐ ржкрж░рж┐ржмрж░рзНрждрж┐ржд рж╣рзЯрзЗржЫрж┐рж▓ред ржЖржорж┐ ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ backend ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржиржХрзЗ рж╕рзЗржЗ ржХрж╛рж╕рзНржЯржо cookie ржирж╛ржорзЗрж░ рж╕рж╛ржерзЗ рж╕рж╛ржоржЮрзНржЬрж╕рзНржп ржХрж░рж╛рж▓рж╛ржоред рждржмрзБржУ ржХрж╛ржЬ рж╣ржЪрзНржЫрж┐рж▓ ржирж╛ред

ржЕржмрж╢рзЗрж╖рзЗ ржЖржорж┐ ржЪрзВрзЬрж╛ржирзНржд рж╕ржорж╕рзНржпрж╛ржЯрж╛ ржзрж░рждрзЗ ржкрж╛рж░рж▓рж╛ржо: anti-forgery cookie-ржПрж░ SameSite=Strict ржПржмржВ Secure=false ржЫрж┐рж▓ред ржпрзЗрж╣рзЗрждрзБ ржЖржорж╛рж░ ржлрзНрж░ржирзНржЯржПржирзНржб ржУ ржмрзНржпрж╛ржХржПржирзНржб ржЫрж┐рж▓ ржнрж┐ржирзНржи origin-ржП (localhost-ржПрж░ ржнрж┐ржирзНржи ржкрзЛрж░рзНржЯ), ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржирзАрж░ржмрзЗ рж╕рзЗржЗ cookie-ржХрзЗ рж░рж┐ржЬрзЗржХрзНржЯ ржХрж░ржЫрж┐рж▓ред

---

**The Fix:**

1я╕ПтГг antiforgery cookie-ржХрзЗ SameSite=None ржПржмржВ Secure=true рж╕рзЗржЯ ржХрж░рж▓рж╛ржо  
2я╕ПтГг cookie ржирж╛ржоржЯрж┐ рж╕рзНржкрж╖рзНржЯржнрж╛ржмрзЗ Aspire-ржПрж░ ржбрж┐ржлрж▓рзНржЯ ржЕржирзБржпрж╛рзЯрзА ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж▓рж╛ржо  
3я╕ПтГг ржлрзНрж░ржирзНржЯржПржирзНржбрзЗрж░ рж╕ржм ржкрзНрж░рзЯрзЛржЬржирзАрзЯ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗ withCredentials ржПржирж╛ржмрж▓ ржХрж░рж▓рж╛ржо  
4я╕ПтГг CORS рж╕рзЗржЯржЖржкрзЗ credentials ржЕржирзБржорждрж┐ ржжрж┐рж▓рж╛ржо

ржПрж░ржкрж░рзЗржЗ рж╕ржм ржХрж┐ржЫрзБ ржкрзНрж░рждрзНржпрж╛рж╢рж╛ржорждрзЛ ржХрж╛ржЬ ржХрж░рж▓ред

---

ЁЯСЙЁЯП╝ **Takeaways:**  
1я╕ПтГг ASP.NET Core Minimal APIs-ржП form uploads-ржПрж░ ржЬржирзНржп anti-forgery ржбрж┐ржлрж▓рзНржЯржнрж╛ржмрзЗ ржПржирж╛ржмрж▓ ржерж╛ржХрзЗ  
2я╕ПтГг Token-based authentication ржерж╛ржХрж▓рзЗржУ ржПржЗ ржХрзНрж╖рзЗрждрзНрж░рзЗ CSRF protection ржерзЗржХрзЗ ржЖржкржирж┐ ржорзБржХрзНржд ржиржи  
3я╕ПтГг Cross-origin рж╕рзЗржЯржЖржкрзЗ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи:  
тЮбя╕П Cookie settings рж╕ржарж┐ржХ ржЖржЫрзЗ (SameSite=None, Secure=true)  
тЮбя╕П CORS-ржП credentials ржЕржирзБржорзЛржжрж┐ржд  
тЮбя╕П ржлрзНрж░ржирзНржЯржПржирзНржбрзЗ withCredentials: true ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ

